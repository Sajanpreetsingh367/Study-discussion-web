<!-- CONTEST SCREEN -->
<div id="contestScreen" class="hidden">
  <button class="backBtn" onclick="goHomeFromContest()">‚≠† Back</button>
  <h2>üèÜ Contest</h2>
  <p>Participants Joined: <span id="joinedCount">0</span></p>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div class="notice">
    Dear aspirants, candidates scoring above 90 will be shortlisted.
    The total contest prize depends on total participants‚Äô entry fees, after a 2% platform fee deduction.
  </div>
  <button class="primary" onclick="payEntry()">Pay Entry Fee ‚Çπ10</button>
  <button class="secondary" id="joinBtn" disabled onclick="openRegistration()">Join Quiz</button>
</div>

<!-- REGISTRATION SCREEN -->
<div id="registrationScreen" class="hidden">
  <button class="backBtn" onclick="backToContest()">‚≠† Back</button>
  <h2>üìù Quiz Registration</h2>
  <input id="fullName" class="inputBox" placeholder="Full Name">
  <input id="fatherName" class="inputBox" placeholder="Father's Name">
  <input id="mobileNumber" class="inputBox" placeholder="Mobile Number" type="tel">
  <div class="notice">
    Enter correct details. Quiz duration: <b>6 minutes</b>. Timer will auto-submit.
  </div>
  <button class="secondary" onclick="submitDetails()">Submit Details</button>
  <button class="primary" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- QUIZ SCREEN -->
<div id="quizScreen" class="hidden">
  <button class="backBtn" onclick="exitQuiz()">‚≠† Exit</button>
  <h2 id="timer">‚è± 06:00</h2>
  <div id="quizBox"></div>
</div>

<!-- RESULT SCREEN -->
<div id="resultScreen" class="hidden">
  <h2>üéâ Quiz Completed!</h2>
  <p id="scoreText"></p>
  <img id="shortlistImg" class="hidden" src="https://cdn-icons-png.flaticon.com/512/992/992703.png" width="100">
  <button class="primary" onclick="goHome()">Back to Home</button>
</div>

<script>
const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co"; 
const SUPABASE_KEY = "YOUR_ANON_KEY"; 
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const quizUrl = "https://cdn.jsdelivr.net/gh/Sajanpreet35/Upsc-quiz-/upsc_quiz.json";
let quizData=[], current=0, score=0, timerInt, timeLeft=360, userData={};

function payEntry(){
  alert("‚úÖ Payment Successful (Demo)");
  document.getElementById("joinBtn").disabled=false;
  document.getElementById("joinBtn").style.opacity="1";
}

function openRegistration(){
  document.getElementById("contestScreen").classList.add("hidden");
  document.getElementById("registrationScreen").classList.remove("hidden");
}

async function submitDetails(){
  const full=document.getElementById("fullName").value.trim();
  const father=document.getElementById("fatherName").value.trim();
  const mobile=document.getElementById("mobileNumber").value.trim();
  if(!full||!father||!mobile){alert("Please fill all details."); return;}
  userData={full,father,mobile};
  await supabaseClient.from("aspirants").insert([{full_name:full,father_name:father,mobile_number:mobile}]);
  alert("‚úÖ Details Saved Successfully!");
}

async function startQuiz(){
  document.getElementById("registrationScreen").classList.add("hidden");
  document.getElementById("quizScreen").classList.remove("hidden");
  const res = await fetch(quizUrl);
  quizData = await res.json();
  startTimer();
  showQuestion();
}

function startTimer(){
  timerInt = setInterval(()=>{
    let min=Math.floor(timeLeft/60), sec=timeLeft%60;
    document.getElementById("timer").innerText = `‚è± ${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    if(timeLeft<=0){clearInterval(timerInt); finishQuiz();}
    timeLeft--;
  },1000);
}

function showQuestion(){
  if(current>=quizData.length){ finishQuiz(); return; }
  let q = quizData[current];
  const box = document.getElementById("quizBox");
  box.innerHTML = `<h3>Q${current+1}. ${q.question}</h3>`;
  if(q.image) box.innerHTML += `<img src="${q.image}" style="width:100%;margin:10px 0;border-radius:10px;">`;
  
  Object.entries(q.options).forEach(([key,val])=>{
    let div = document.createElement("div");
    div.className="option"; div.innerText=`${key}. ${val}`;
    div.onclick=()=>{
      if(key===q.correct_answer) score++;
      nextQuestion();
    };
    box.appendChild(div);
  });
  
  let nextBtn = document.createElement("button");
  nextBtn.innerText = current===quizData.length-1?"Finish Quiz":"Next";
  nextBtn.className="primary"; nextBtn.style.marginTop="20px";
  nextBtn.onclick = ()=> nextQuestion();
  box.appendChild(nextBtn);
}

function nextQuestion(){ current++; showQuestion(); }

async function finishQuiz(){
  clearInterval(timerInt);
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("resultScreen").classList.remove("hidden");
  document.getElementById("scoreText").innerText=`You scored ${score}/${quizData.length}`;
  if(score>=90) document.getElementById("shortlistImg").classList.remove("hidden");
  // save score in supabase
  await supabaseClient.from("aspirants").update({score:score}).eq("mobile_number",userData.mobile);
}

function exitQuiz(){ if(confirm("Exit quiz?")) goHome(); }
function backToContest(){ document.getElementById("registrationScreen").classList.add("hidden"); document.getElementById("contestScreen").classList.remove("hidden"); }
function goHomeFromContest(){ document.getElementById("contestScreen").classList.add("hidden"); document.getElementById("homeScreen").classList.remove("hidden"); }
function goHome(){ location.reload(); }
</script>
