<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Discussion Club ‚Äî Fixed</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root { --accent:#6C63FF; --accent2:#00C2A8; }
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{
  background:radial-gradient(circle at 50% 20%,#2a2a72 0%,#000 90%);
  color:white;text-align:center;padding:18px;overflow-x:hidden;
}
.hidden{display:none !important;}
.grid{margin-top:25px;display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
.card{
  background:rgba(255,255,255,0.08);
  padding:18px;border-radius:14px;cursor:pointer;transition:0.25s;
}
.card:hover{background:rgba(255,255,255,0.18);}
.card img{width:70px;height:70px;margin-bottom:6px;}
.logoutBtn{
  margin-top:35px;background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;padding:12px 22px;border-radius:10px;color:white;font-weight:700;
  cursor:pointer;
}
.backBtn{
  position:absolute;left:12px;top:12px;border:none;
  background:rgba(255,255,255,0.13);
  padding:8px 14px;border-radius:10px;color:white;cursor:pointer;
}
.sectionHeader{
  background:rgba(255,255,255,0.15);
  padding:14px 0;border-radius:12px;margin-bottom:16px;
  font-size:20px;font-weight:600;
  text-transform:capitalize;
}
#imgList img{width:100%;border-radius:14px;margin-bottom:20px;border:2px solid rgba(255,255,255,0.2);}
input{width:80%;padding:10px;margin:8px;border:none;border-radius:8px;font-size:15px;text-align:center;}
button{cursor:pointer;}
.option{background:rgba(255,255,255,0.08);margin:8px 0;padding:10px;border-radius:8px;cursor:pointer;transition:.2s;}
.option:hover{background:rgba(255,255,255,0.18);}
.timerBox{background:rgba(255,255,255,0.1);display:inline-block;padding:6px 12px;border-radius:8px;margin-bottom:12px;font-weight:600;}
.popupOverlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;
  color:white;font-size:22px;flex-direction:column;z-index:1000;
}
.popupCard{
  background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));
  padding:22px;border-radius:12px;text-align:center;max-width:320px;
}
</style>
</head>
<body>

<!-- HOME -->
<div id="homeScreen">
  <h2>Your Course</h2>
  <p>Select a learning section</p>
  <div class="grid">
    <div class="card" onclick="openSection('current')"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"><div>Current Affairs</div></div>
    <div class="card" onclick="openSection('practice')"><img src="https://cdn-icons-png.flaticon.com/512/201/201572.png"><div>Practice Questions</div></div>
    <div class="card" onclick="openSection('mindmap')"><img src="https://cdn-icons-png.flaticon.com/512/952/952717.png"><div>Mind Maps</div></div>
    <div class="card" onclick="openSection('interview')"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135810.png"><div>Interview Q&A</div></div>
    <div class="card" onclick="openSection('books')"><img src="https://cdn-icons-png.flaticon.com/512/942/942748.png"><div>UPSC Book Summary</div></div>
    <div class="card" onclick="openSection('social')"><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png"><div>Social Media Material</div></div>
    <div class="card" onclick="openSection('contest')"><img src="https://cdn-icons-png.flaticon.com/512/1828/1828884.png"><div>Contest</div></div>
  </div>
  <button class="logoutBtn" onclick="logoutUser()">Logout</button>
</div>

<!-- SECTION -->
<div id="sectionScreen" class="hidden">
  <button class="backBtn" onclick="goBack()">‚≠† Back</button>
  <div class="sectionHeader" id="secTitle"></div>
  <div id="imgList"></div>
</div>

<!-- CONTEST -->
<div id="contestScreen" class="hidden">
  <button class="backBtn" onclick="goBack()">‚≠† Back</button>
  <div class="sectionHeader">Contest</div>

  <div style="background:rgba(255,255,255,0.1);padding:16px;border-radius:16px;">
    <p style="font-size:15px;font-weight:600;">Participants Joined: <span id="joinedCount">0</span></p>
    <div style="width:100%;height:12px;background:#333;border-radius:8px;margin-top:10px;">
      <div id="progressBar" style="height:100%;background:limegreen;width:0%;border-radius:8px;"></div>
    </div>
  </div>

  <div id="participantList" style="margin-top:18px;text-align:left;padding:10px;max-height:220px;overflow:auto;background:rgba(255,255,255,0.05);border-radius:12px;"></div>

  <button id="payBtn" style="margin-top:18px;background:linear-gradient(90deg,#ff5858,#ff9e00);border:none;padding:12px 22px;border-radius:10px;font-size:15px;font-weight:700;color:white;" onclick="payEntry()">Pay Entry Fee ‚Çπ10</button>
  <button id="joinBtn" disabled style="margin-top:12px;background:#555;border:none;padding:10px 18px;border-radius:10px;font-size:15px;font-weight:700;color:white;cursor:not-allowed;" onclick="openContestQuiz()">Join Quiz</button>
</div>

<!-- REGISTRATION -->
<div id="contestQuizScreen" class="hidden">
  <div class="sectionHeader">Contest Quiz Registration</div>
  <input id="name" placeholder="Full Name" />
  <input id="father" placeholder="Father's Name" />
  <input id="mobile" placeholder="Mobile Number" />
  <div style="margin-top:12px;">
    <button class="logoutBtn" onclick="submitDetails()">Submit Details</button>
  </div>
  <p id="msg" style="margin-top:10px"></p>
  <div style="margin-top:14px;">
    <button style="background:linear-gradient(90deg,#00b09b,#96c93d);border:none;padding:12px 22px;border-radius:10px;font-size:15px;font-weight:700;color:white;" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<!-- QUIZ -->
<div id="quizScreen" class="hidden">
  <button class="backBtn" onclick="confirmExitQuiz()">‚≠† Exit</button>
  <div class="sectionHeader">Contest Quiz</div>
  <div class="timerBox">‚è± <span id="timer">06:00</span></div>
  <div id="quizBox" style="margin-top:12px;"></div>

  <!-- popup is placed INSIDE quizScreen so it cannot overlay home -->
  <div id="popup" class="hidden" aria-hidden="true">
    <div class="popupOverlay">
      <div class="popupCard">
        <div style="font-size:20px;margin-bottom:14px;">‚è∞ Time Out!</div>
        <div style="margin-bottom:14px;color:#ddd;">Your time has ended. Submitting your quiz now.</div>
        <button class="logoutBtn" onclick="closePopup()">Submit Quiz</button>
      </div>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="resultScreen" class="hidden">
  <div class="sectionHeader">Quiz Completed!</div>
  <h3 id="scoreText"></h3>
  <button onclick="goHome()" class="logoutBtn">Back to Home</button>
</div>

<script>
/* ---------- Config (same as before) ---------- */
const links = {
  current:"https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_currentaffairs.json",
  practice:"https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upsc%20practise%20questions.json",
  mindmap:"https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/mindmaps.json",
  interview:"https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upscinterviewpractisequestions.json",
  books:"https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_books.json",
  social:"https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/social_media_material.json",
  contest:"https://raw.githubusercontent.com/Sajanpreet35/Upsc-quiz-/main/upsc_quiz.json"
};

const SUPABASE_URL = "https://zkqegvyxmtwyznizuhjt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcWVndnl4bXR3eXpuaXp1aGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjkxMDYsImV4cCI6MjA3NjIwNTEwNn0.hC01DVzpgFg_cAVBs-Q6dalvUh1oU5OJ5NxkoEVY36o";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- Navigation & sections ---------- */
async function openSection(sec){
  document.getElementById("homeScreen").classList.add("hidden");
  if(sec==="contest"){ openContest(); return; }
  document.getElementById("sectionScreen").classList.remove("hidden");
  const data = await fetch(links[sec]).then(r=>r.json()).catch(()=>({title:sec, images:[]}));
  document.getElementById("secTitle").innerText = data.title || sec;
  const list = document.getElementById("imgList");
  list.innerHTML = "";
  (data.images||[]).forEach(src=>{ const img = document.createElement('img'); img.src = src; list.appendChild(img); });
}
function goBack(){
  document.getElementById("homeScreen").classList.remove("hidden");
  document.getElementById("sectionScreen").classList.add("hidden");
  document.getElementById("contestScreen").classList.add("hidden");
  document.getElementById("contestQuizScreen").classList.add("hidden");
}
/* ---------- Contest panel (reads aspirants from supabase) ---------- */
async function openContest(){
  document.getElementById("homeScreen").classList.add("hidden");
  document.getElementById("contestScreen").classList.remove("hidden");
  const { data, error } = await supabase.from("aspirants").select("*").order('id',{ascending:false}).limit(100);
  const joined = data ? data.length : 0;
  const max = 100000;
  document.getElementById("joinedCount").innerText = joined;
  document.getElementById("progressBar").style.width = (joined / max) * 100 + "%";
  const list = document.getElementById("participantList");
  list.innerHTML = (data || []).map(p => `<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03);">üë§ <strong>${escapeHtml(p.name)}</strong> ¬∑ ${escapeHtml(p.mobile)}</div>`).join('') || "<div style='color:#ccc;'>No participants yet</div>";
}

/* ---------- payment/demo join ---------- */
function payEntry(){
  alert("‚úÖ Payment simulated (demo). You can now Join Quiz.");
  const btn = document.getElementById("joinBtn");
  btn.disabled = false;
  btn.style.background = "linear-gradient(90deg,#007bff,#00d4ff)";
  btn.style.cursor = "pointer";
}
function openContestQuiz(){
  document.getElementById("contestScreen").classList.add("hidden");
  document.getElementById("contestQuizScreen").classList.remove("hidden");
}

/* ---------- registration (save to supabase) ---------- */
async function submitDetails(){
  const name = document.getElementById("name").value.trim();
  const father = document.getElementById("father").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const msg = document.getElementById("msg");
  msg.innerText = "";
  if(!name || !father || !mobile){ msg.innerText = "‚ö†Ô∏è Please fill all fields."; return; }
  const { data, error } = await supabase.from("aspirants").insert([{ name, father_name: father, mobile }]);
  if(error){ msg.innerText = "‚ùå Failed to save: " + error.message; }
  else { msg.innerText = "‚úÖ Saved successfully!"; }
}

/* ---------- quiz system ---------- */
let quizData = [], current = 0, score = 0, userAnswers = {}, timerInt = null, seconds = 0;

async function startQuiz(){
  // hide registration, show quiz
  document.getElementById("contestQuizScreen").classList.add("hidden");
  document.getElementById("quizScreen").classList.remove("hidden");

  // load quiz JSON
  try{
    const res = await fetch(links.contest);
    quizData = await res.json();
  }catch(e){
    alert("Failed to load quiz JSON.");
    quizData = [];
  }

  current = 0; score = 0; userAnswers = {};
  seconds = 6 * 60; // 6 minutes
  updateTimerDisplay();
  timerInt = setInterval(()=> {
    seconds--;
    updateTimerDisplay();
    if(seconds <= 0){
      clearInterval(timerInt);
      showPopup(); // time out popup (inside quiz screen)
    }
  }, 1000);
  showQuestion();
}

function updateTimerDisplay(){
  const m = Math.floor(seconds/60), s = seconds % 60;
  document.getElementById("timer").innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function showQuestion(){
  const q = quizData[current];
  const box = document.getElementById("quizBox");
  if(!q){
    finishQuiz();
    return;
  }
  box.innerHTML = `<h3 style="text-align:left;">Q${current+1}. ${escapeHtml(q.question || '')}</h3>`;
  // options (expected as object like { A: "text", B: "text" } )
  const opts = q.options || {};
  for(const key of Object.keys(opts)){
    const div = document.createElement('div');
    div.className = 'option';
    div.innerText = `${key}. ${opts[key]}`;
    div.onclick = () => { userAnswers[current] = key; nextQuestion(); };
    box.appendChild(div);
  }
  // if last question: show submit button at bottom
  if(current === (quizData.length - 1)){
    const submitBtn = document.createElement('button');
    submitBtn.className = 'logoutBtn';
    submitBtn.style.marginTop = '12px';
    submitBtn.innerText = 'Submit Quiz';
    submitBtn.onclick = finishQuiz;
    box.appendChild(submitBtn);
  } else {
    // also provide an explicit Next button (optional) ‚Äî user can click option to auto-advance, but add Next to allow skip
    const nextBtn = document.createElement('button');
    nextBtn.className = 'logoutBtn';
    nextBtn.style.marginTop = '12px';
    nextBtn.innerText = 'Next';
    nextBtn.onclick = () => { current++; showQuestion(); };
    box.appendChild(nextBtn);
  }
}

function nextQuestion(){ current++; if(current < quizData.length) showQuestion(); else finishQuiz(); }

function showPopup(){
  const popup = document.getElementById("popup");
  // ensure popup is visible only in quiz screen
  if(!popup) return;
  popup.classList.remove('hidden');
  // auto submit after short delay so user sees popup
  setTimeout(()=> finishQuiz(), 1200);
}

function closePopup(){ // user pressed Submit from popup
  document.getElementById("popup").classList.add('hidden');
  finishQuiz();
}

async function finishQuiz(){
  if(timerInt) { clearInterval(timerInt); timerInt = null; }
  // calculate score
  score = 0;
  for(let i=0;i<quizData.length;i++){
    const q = quizData[i];
    if(!q) continue;
    const correct = (q.correct_answer || q.answer || '').toString().trim();
    const sel = (userAnswers[i] || '').toString().trim();
    if(sel && correct && sel === correct) score++;
  }

  // show result screen
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("resultScreen").classList.remove("hidden");
  document.getElementById("scoreText").innerText = `You scored ${score} / ${quizData.length}`;

  // save to supabase contest_result table
  try{
    await supabase.from('contest_result').insert([{ score, timestamp: new Date().toISOString() }]);
  }catch(e){
    console.warn("Failed to save score:", e);
  }
}

/* ---------- helpers & navigation ---------- */
function goHome(){
  document.getElementById("resultScreen").classList.add("hidden");
  document.getElementById("homeScreen").classList.remove("hidden");
  // reset quiz state
  quizData = []; current = 0; score = 0; userAnswers = {};
}
function logoutUser(){ localStorage.clear(); window.location.href = "index.html"; }
function escapeHtml(unsafe){ return String(unsafe||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function confirmExitQuiz(){ if(confirm("Exit quiz? Your progress will be lost.")){ // reset
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("homeScreen").classList.remove("hidden");
  quizData=[]; current=0; userAnswers={}; seconds=0;
} }

/* ---------- small init (nothing auto-starts) ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // nothing to run on load ‚Äî UI starts idle
});
</script>
</body>
</html>
