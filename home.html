<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://zkqegvyxmtwyznizuhjt.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcWVndnl4bXR3eXpuaXp1aGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjkxMDYsImV4cCI6MjA3NjIwNTEwNn0.hC01DVzpgFg_cAVBs-Q6dalvUh1oU5OJ5NxkoEVY36o";
const supabase = createClient(supabaseUrl, supabaseKey);

// âœ… JSON Links
const links = {
  current: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_currentaffairs.json",
  practice: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upsc%20practise%20questions.json",
  mindmap: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/mindmaps.json",
  interview: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upscinterviewpractisequestions.json",
  books: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_books.json",
  social: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/social_media_material.json",
  contest: "NO_JSON",
  quiz: "https://raw.githubusercontent.com/Sajanpreet35/Upsc-quiz-/main/upsc_quiz.json"
};

document.getElementById("examName").innerText =
(localStorage.getItem("selectedExam") || "UPSC") + " Course";

// âœ… NAVIGATION
async function openSection(sec){
  document.getElementById("homeScreen").classList.add("hidden");
  if(sec === "contest"){ openContest(); return; }

  document.getElementById("sectionScreen").classList.remove("hidden");
  let data = await fetch(links[sec]).then(r=>r.json());
  document.getElementById("secTitle").innerText = data.title || sec;

  let list = document.getElementById("imgList");
  list.innerHTML = "";
  if (data.images) {
    data.images.forEach(src=>{
      let i=document.createElement("img");
      i.src=src;
      list.appendChild(i);
    });
  }
}

// âœ… Contest System
let joined = 52290;
let max = 100000;

function openContest(){
  document.getElementById("contestScreen").classList.remove("hidden");
  updateProgress();
}

function updateProgress(){
  let percentage = (joined / max) * 100;
  document.getElementById("joinedCount").innerText = joined;
  document.getElementById("progressBar").style.width = percentage + "%";
}

function payEntry(){
  alert("âœ… Payment Success (Testing Mode)");
  localStorage.setItem("paidEntry","true");
  document.getElementById("joinBtn").disabled = false;
  document.getElementById("joinBtn").style.cursor="pointer";
  document.getElementById("joinBtn").style.background="linear-gradient(90deg,#007bff,#00d4ff)";
  document.getElementById("joinBtn").onclick = startQuiz;
}

// âœ… QUIZ SYSTEM
let quizData = [];
let currentQuestion = 0;
let score = 0;
let userAnswers = {};

async function startQuiz(){
  document.getElementById("contestScreen").classList.add("hidden");
  let res = await fetch(links.quiz);
  quizData = await res.json();
  currentQuestion = 0;
  score = 0;
  userAnswers = {};
  showQuestion();
}

function showQuestion(){
  let q = quizData[currentQuestion];
  let container = document.createElement("div");
  container.innerHTML = `
    <button class="backBtn" onclick="goBack()">â­  Back</button>
    <h2>Question ${currentQuestion + 1} of ${quizData.length}</h2>
    <img src="${q.question_image}" style="width:100%;border-radius:12px;margin:10px 0;">
    <div id="options">
      ${Object.entries(q.options).map(([key, val])=>`
        <div style="margin:8px;">
          <label><input type="radio" name="option" value="${key}" style="margin-right:8px;">${key}: ${val}</label>
        </div>
      `).join("")}
    </div>
    <button id="nextBtn" style="margin-top:20px;padding:12px 22px;border:none;border-radius:10px;background:linear-gradient(90deg,#6C63FF,#00C2A8);color:white;font-weight:700;">
      ${currentQuestion === quizData.length-1 ? "Submit Quiz" : "Next Question"}
    </button>
  `;
  document.body.innerHTML = "";
  document.body.appendChild(container);
  document.getElementById("nextBtn").onclick = nextQuestion;
}

function nextQuestion(){
  let selected = document.querySelector('input[name="option"]:checked');
  if(!selected){ alert("Please select an answer"); return; }

  let ans = selected.value;
  userAnswers[currentQuestion] = ans;
  if(ans === quizData[currentQuestion].correct_answer) score++;

  if(currentQuestion < quizData.length - 1){
    currentQuestion++;
    showQuestion();
  } else {
    submitQuiz();
  }
}

async function submitQuiz(){
  alert(`ðŸŽ‰ Quiz Submitted! Your score: ${score}/${quizData.length}`);
  await supabase.from("contest_result").insert([
    {
      username: localStorage.getItem("username") || "Anonymous",
      score: score,
      total: quizData.length,
      created_at: new Date()
    }
  ]);
  goBack();
}

// âœ… BACK TO HOME
window.goBack = function(){
  location.reload();
};

// âœ… LOGOUT
window.logoutUser = function(){
  localStorage.clear();
  window.location.href="index.html";
};

</script>
