<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Discussion Club</title>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwbIHTMWM_AQ-NlsdXGDzAfoC8Tf8lZiY",
  authDomain: "study-discussion-club.firebaseapp.com",
  projectId: "study-discussion-club",
  storageBucket: "study-discussion-club.appspot.com",
  messagingSenderId: "383378613377",
  appId: "1:383378613377:web:3b932c6b42076352811980"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window._firebase = { db, collection, addDoc, onSnapshot };
</script>

<!-- Supabase -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
window._supabase = createClient(
  "https://zkqegvyxmtwyznizuhjt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcWVndnl4bXR3eXpuaXp1aGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjkxMDYsImV4cCI6MjA3NjIwNTEwNn0.hC01DVzpgFg_cAVBs-Q6dalvUh1oU5OJ5NxkoEVY36o"
);
</script>

<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#f8f8f8;}
.container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;min-height:100vh;}
input,button{padding:10px;margin:5px;width:90%;max-width:400px;border-radius:8px;border:1px solid #ccc;}
button{font-weight:bold;color:white;border:none;cursor:pointer;background:#007AFF;}
.back-button{position:absolute;top:20px;left:20px;cursor:pointer;font-size:20px;}
.image-frame{border-radius:10px;overflow:hidden;margin:10px;box-shadow:0 2px 8px rgba(0,0,0,0.15);background:#fff;transition:0.3s;width:90%;}
.image-frame img{width:100%;display:block;}
.next-btn{background-color:#007AFF;}
.next-btn:disabled{background-color:gray;cursor:not-allowed;}
.notice-box{background:#f0f0f0;padding:10px;border-radius:8px;margin:10px 0;font-size:14px;}
.section-title{font-weight:bold;font-size:16px;margin-bottom:5px;}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

function App() {
  const [screen, setScreen] = useState("welcome");
  const [signupData, setSignupData] = useState({username:"", email:"", password:"", mobile:""});
  const [quizAnswers, setQuizAnswers] = useState({});
  const sections = [
    {name:"Current Affairs", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/current_affairs.json"},
    {name:"Practice Questions", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/practice_questions.json"},
    {name:"Mind Maps", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/mind_map.json"},
    {name:"Books Summary", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/books_summary.json"},
    {name:"Interview", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/interview_practise.json"},
    {name:"Discussion", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/sdc_news.json"},
  ];

  // Screens
  if(screen==="welcome") return (
    <div className="container">
      <h2>Welcome to Study Discussion Club</h2>
      <button onClick={()=>setScreen("signup")}>Next</button>
    </div>
  );

  if(screen==="signup") return (
    <div className="container">
      <h2>Signup</h2>
      {Object.keys(signupData).map(key=>
        <input key={key} placeholder={key.toUpperCase()} type={key==="password"?"password":"text"} 
        value={signupData[key]} onChange={e=>setSignupData({...signupData,[key]:e.target.value})}/>
      )}
      <button onClick={()=>{ 
        if(Object.values(signupData).every(v=>v!=="")) setScreen("home"); 
        else alert("Fill all fields");
      }}>Signup</button>
    </div>
  );

  if(screen==="home") return (
    <div className="container">
      <h2>Sections</h2>
      {sections.map((s,i)=><div key={i} className="exam-box" onClick={()=>setScreen(`section-${i}`)}>{s.name}</div>)}
      <div className="exam-box" onClick={()=>setScreen("contest")}>Contest</div>
    </div>
  );

  // Section screen
  const idx = parseInt(screen.replace("section-",""));
  if(!isNaN(idx) && sections[idx]) return <StudySection section={sections[idx]} back={()=>setScreen("home")} />;

  if(screen==="contest") return <ContestScreen back={()=>setScreen("home")} setScreen={setScreen}/>;
  if(screen==="quiz") return <QuizScreen back={()=>setScreen("contest")} answers={quizAnswers} setAnswers={setQuizAnswers}/>;

  return null;
}

// Study Section
function StudySection({section,back}){
  const [data,setData] = useState([]);
  useEffect(()=>{ fetch(section.url).then(r=>r.json()).then(j=>setData(j)).catch(e=>console.log(e)); },[section.url]);
  return (
    <div className="container">
      <div className="back-button" onClick={back}>ðŸ”™</div>
      <h2>{section.name}</h2>
      {data.map((item,i)=><div key={i} className="image-frame"><img src={item.image}/></div>)}
    </div>
  );
}

// Contest
function ContestScreen({back,setScreen}){
  const [participants,setParticipants] = useState([]);
  const [upiPaid,setUpiPaid] = useState(false);
  const joinEnabled = upiPaid;

  useEffect(()=>{
    const { db, collection, onSnapshot } = window._firebase;
    const unsub = onSnapshot(collection(db,"contest_participants"), snapshot=>{
      setParticipants(snapshot.docs.map(doc=>doc.data().name));
    });
    return ()=>unsub();
  },[]);

  const payUPI = async ()=>{
    alert("Payment done!");
    setUpiPaid(true);
    const { db, collection, addDoc } = window._firebase;
    await addDoc(collection(db,"contest_participants"),{name:"You",paid:true});
  };

  return (
    <div className="container">
      <div className="back-button" onClick={back}>ðŸ”™</div>
      <h2>Contest</h2>
      <div className="notice-box"><b>Participants:</b><ul>{participants.map((p,i)=><li key={i}>{p}</li>)}</ul></div>
      <button onClick={payUPI}>Pay Entry Fee â‚¹7</button>
      <button onClick={()=>joinEnabled && setScreen("quiz")} disabled={!joinEnabled} className="next-btn">Join Quiz</button>
    </div>
  );
}

// Quiz (UPDATED SUPABASE LOGIC)
function QuizScreen({back,answers,setAnswers}){
  const [questions,setQuestions]=useState([]);
  const [current,setCurrent]=useState(0);

  useEffect(()=>{
    fetch("https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/practice_questions.json")
    .then(r=>r.json()).then(j=>setQuestions(j)).catch(e=>console.log(e));
  },[]);

  if(questions.length===0) return <div className="container">Loading Quiz...</div>;
  const q = questions[current];

  const handleNext = async ()=>{
    if(current < questions.length - 1){
      setCurrent(current + 1);
    } else {
      const supabase = window._supabase;
      const name = prompt("Enter Name");
      const email = prompt("Enter Email");
      const mobile = prompt("Enter Mobile");
      try{
        const { error } = await supabase
          .from("quiz_responses")
          .insert([{ name, email, mobile, answers }]);
        if(error) throw error;
        alert("âœ… Quiz submitted successfully!");
        back();
      }catch(err){
        alert("âŒ Error saving to Supabase: " + err.message);
      }
    }
  };

  return (
    <div className="container">
      <div className="back-button" onClick={back}>ðŸ”™</div>
      <h2>Contest Quiz</h2>
      <div className="notice-box">Question {current+1}/{questions.length}</div>
      <div className="image-frame"><img src={q.image}/></div>
      {["a","b","c","d"].map(opt=>
        <button key={opt} onClick={()=>setAnswers({...answers,[current]:opt})}>
          {q[opt]}
        </button>
      )}
      <button onClick={handleNext} className="next-btn">
        {current<questions.length-1?"Next":"Submit"}
      </button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
