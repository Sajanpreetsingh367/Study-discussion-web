<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Discussion Club</title>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwbIHTMWM_AQ-NlsdXGDzAfoC8Tf8lZiY",
  authDomain: "study-discussion-club.firebaseapp.com",
  projectId: "study-discussion-club",
  storageBucket: "study-discussion-club.appspot.com",
  messagingSenderId: "383378613377",
  appId: "1:383378613377:web:3b932c6b42076352811980"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window._firebase = { db, collection, addDoc, onSnapshot };
</script>

<!-- Supabase -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
window._supabase = createClient(
  "https://zkqegvyxmtwyznizuhjt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcWVndnl4bXR3eXpuaXp1aGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjkxMDYsImV4cCI6MjA3NjIwNTEwNn0.hC01DVzpgFg_cAVBs-Q6dalvUh1oU5OJ5NxkoEVY36o"
);
</script>

<style>
body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #333; }
.container { display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
input, button { padding: 10px; margin: 6px; width: 90%; max-width: 400px; border-radius: 8px; border: 1px solid #ccc; }
button { font-weight: bold; color: white; background: #007AFF; border: none; cursor: pointer; transition: 0.2s; }
button:hover { background: #005ad1; }
button:disabled { background: gray; cursor: not-allowed; }
.exam-box { background: white; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 15px; margin: 8px 0; text-align: center; font-size: 17px; font-weight: 600; color: #007AFF; transition: 0.2s; width: 90%; max-width: 400px; }
.exam-box:hover { background: #007AFF; color: white; transform: translateY(-2px); }
.back-button { position: absolute; top: 20px; left: 20px; cursor: pointer; font-size: 20px; }
.image-frame { border-radius: 12px; overflow: hidden; margin: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); background: #fff; width: 90%; max-width: 500px; }
.image-frame img { width: 100%; height: auto; display: block; }
.notice-box { background: #fff6e6; padding: 12px; border-radius: 10px; margin: 10px 0; font-size: 14px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
.timer { margin: 10px; font-weight: bold; color: #ff3b30; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

function App() {
  const [screen, setScreen] = useState("welcome");
  const [signupData, setSignupData] = useState({username:"", email:"", password:"", mobile:""});
  const [quizAnswers, setQuizAnswers] = useState({});

  const sections = [
    {name:"Current Affairs", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/current_affairs.json"},
    {name:"Practice Questions", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/practice_questions.json"},
    {name:"Mind Maps", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/mind_map.json"},
    {name:"Books Summary", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/books_summary.json"},
    {name:"Interview", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/interview_practise.json"},
    {name:"Discussion", url:"https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/sdc_news.json"},
  ];

  if(screen==="welcome") return (
    <div className="container">
      <h2>Welcome to Study Discussion Club</h2>
      <button onClick={()=>setScreen("signup")}>Next</button>
    </div>
  );

  if(screen==="signup") return (
    <div className="container">
      <h2>Create Your Account</h2>
      {Object.keys(signupData).map(k=>(
        <input key={k} placeholder={k.toUpperCase()} type={k==="password"?"password":"text"}
          value={signupData[k]} onChange={e=>setSignupData({...signupData,[k]:e.target.value})}/>
      ))}
      <button onClick={()=>Object.values(signupData).every(v=>v!=="")?setScreen("home"):alert("Fill all fields")}>Signup</button>
    </div>
  );

  if(screen==="home") return (
    <div className="container">
      <h2>üìö Study Sections</h2>
      {sections.map((s,i)=><div key={i} className="exam-box" onClick={()=>setScreen(`section-${i}`)}>{s.name}</div>)}
      <div className="exam-box" style={{background:"#fff6e6", color:"#ff7b00"}} onClick={()=>setScreen("contest")}>üéØ Contest</div>
    </div>
  );

  const idx = parseInt(screen.replace("section-",""));
  if(!isNaN(idx)) return <StudySection section={sections[idx]} back={()=>setScreen("home")}/>;
  if(screen==="contest") return <ContestScreen back={()=>setScreen("home")} setScreen={setScreen}/>;
  if(screen==="quiz") return <QuizScreen back={()=>setScreen("contest")} answers={quizAnswers} setAnswers={setQuizAnswers}/>;
  return null;
}

function StudySection({section,back}) {
  const [data,setData] = useState([]);
  const [error,setError] = useState("");

  useEffect(()=>{
    fetch(section.url).then(r=>r.json()).then(j=>setData(j))
      .catch(()=>setError("‚ùå Error loading images"));
  },[section.url]);

  return (
    <div className="container">
      <div className="back-button" onClick={back}>üîô</div>
      <h2>{section.name}</h2>
      {error && <div className="notice-box">{error}</div>}
      {data.length===0 && !error && <p>Loading...</p>}
      {data.map((it,i)=><div key={i} className="image-frame"><img src={it.image || it.url || "https://via.placeholder.com/400x200"} /></div>)}
    </div>
  );
}

function ContestScreen({back,setScreen}) {
  const [participants,setParticipants]=useState([]);
  const [paid,setPaid]=useState(false);

  useEffect(()=>{
    const { db, collection, onSnapshot } = window._firebase;
    const unsub = onSnapshot(collection(db,"contest_participants"), snap=>{
      setParticipants(snap.docs.map(d=>d.data().name));
    });
    return ()=>unsub();
  },[]);

  const payNow=async()=>{
    alert("‚úÖ Payment ‚Çπ10 done!");
    setPaid(true);
    const { db, collection, addDoc } = window._firebase;
    await addDoc(collection(db,"contest_participants"),{name:"You",paid:true});
  };

  return (
    <div className="container">
      <div className="back-button" onClick={back}>üîô</div>
      <h2>Contest</h2>
      <div className="notice-box">
        <b>Participants:</b>
        <ul>{participants.map((p,i)=><li key={i}>{p}</li>)}</ul>
      </div>
      <button onClick={payNow}>Pay Entry Fee ‚Çπ10</button>
      <button disabled={!paid} onClick={()=>setScreen("quiz")}>Join Quiz</button>
      <div className="notice-box">
        Dear User, if payment fails or no response in 1 minute, you will be redirected to manual verification form.
      </div>
    </div>
  );
}

function QuizScreen({back,answers,setAnswers}) {
  const [questions,setQuestions]=useState([]);
  const [current,setCurrent]=useState(0);
  const [timer,setTimer]=useState(240);

  useEffect(()=>{
    fetch("https://raw.githubusercontent.com/Sajanpreetsingh367/Gill-Tarn-taran/main/practice_questions.json")
      .then(r=>r.json()).then(j=>setQuestions(j)).catch(console.log);
  },[]);

  useEffect(()=>{
    const t=setInterval(()=>{
      setTimer(v=>{
        if(v<=1){
          clearInterval(t);
          alert("‚è∞ Time over!");
          back();
          return 0;
        }
        return v-1;
      });
    },1000);
    return ()=>clearInterval(t);
  },[]);

  if(questions.length===0) return <div className="container">Loading Quiz...</div>;
  const q=questions[current];
  const next=async()=>{
    if(current<questions.length-1)setCurrent(current+1);
    else{
      const supabase=window._supabase;
      const name=prompt("Enter Name");
      const email=prompt("Enter Email");
      const mobile=prompt("Enter Mobile");
      const { error } = await supabase.from("quiz_responses").insert([{name,email,mobile,answers}]);
      if(error) alert("‚ùå " + error.message);
      else alert("‚úÖ Quiz submitted!");
      back();
    }
  };
  const min=Math.floor(timer/60), sec=timer%60;

  return (
    <div className="container">
      <div className="back-button" onClick={back}>üîô</div>
      <h2>Contest Quiz</h2>
      <div className="timer">‚è≥ {min}:{sec.toString().padStart(2,"0")} min</div>
      <div className="image-frame"><img src={q.image || "https://via.placeholder.com/400x200"} /></div>
      {["a","b","c","d"].map(opt=>
        <button key={opt} onClick={()=>setAnswers({...answers,[current]:opt})}>
          {q[opt]}
        </button>
      )}
      <button onClick={next}>{current<questions.length-1?"Next":"Submit"}</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
