<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Study Discussion Club</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root { --accent:#6C63FF; --accent2:#00C2A8; }
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{
  background:radial-gradient(circle at 50% 20%,#2a2a72 0%,#000 90%);
  color:white;text-align:center;padding:18px;overflow-x:hidden;
}
.hidden{display:none;}
.grid{margin-top:25px;display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
.card{
  background:rgba(255,255,255,0.08);
  padding:18px;border-radius:14px;cursor:pointer;transition:0.25s;
}
.card:hover{background:rgba(255,255,255,0.18);}
.card img{width:70px;height:70px;margin-bottom:6px;}
.logoutBtn{
  margin-top:35px;background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;padding:12px 22px;border-radius:10px;color:white;font-weight:700;
  cursor:pointer;
}
.backBtn{
  position:absolute;left:12px;top:12px;border:none;
  background:rgba(255,255,255,0.13);
  padding:8px 14px;border-radius:10px;color:white;cursor:pointer;
}
.sectionHeader{
  background:rgba(255,255,255,0.15);
  padding:14px 0;border-radius:12px;margin-bottom:16px;
  font-size:20px;font-weight:600;
}
#imgList img{
  width:100%;border-radius:14px;margin-bottom:20px;
  border:2px solid rgba(255,255,255,0.2);
}
input{
  width:80%;padding:10px;margin:8px;border:none;
  border-radius:8px;font-size:15px;text-align:center;
}
button{cursor:pointer;}
.option{
  background:rgba(255,255,255,0.08);
  margin:8px 0;padding:10px;border-radius:8px;cursor:pointer;transition:.2s;
}
.option:hover{background:rgba(255,255,255,0.18);}
.timerBox{
  background:rgba(255,255,255,0.1);
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  margin-bottom:12px;
  font-weight:600;
}
.notice{
  background:rgba(255,255,255,0.1);
  padding:12px;
  border-radius:10px;
  margin-top:16px;
  font-size:14px;
  color:#ddd;
}
</style>
</head>
<body>

<!-- ✅ HOME -->
<div id="homeScreen">
  <h2>Your Course</h2>
  <p>Select a learning section</p>
  <div class="grid" id="sectionsGrid"></div>
  <button class="logoutBtn" onclick="logoutUser()">Logout</button>
</div>

<!-- ✅ SECTION VIEW -->
<div id="sectionScreen" class="hidden">
  <button class="backBtn" onclick="goHome()">⭠ Back</button>
  <div class="sectionHeader" id="secTitle"></div>
  <div id="imgList"></div>
</div>

<!-- ✅ CONTEST -->
<div id="contestScreen" class="hidden">
  <button class="backBtn" onclick="goHome()">⭠ Back</button>
  <div class="sectionHeader">Contest</div>
  <p>Participants Joined: <span id="joinedCount">0</span></p>
  <div style="width:100%;height:12px;background:#333;border-radius:8px;margin-top:10px;">
    <div id="progressBar" style="height:100%;background:limegreen;width:0%;border-radius:8px;"></div>
  </div>
  <div class="notice" id="contestNotice">Loading contest details...</div>
  <button id="payBtn" class="logoutBtn" style="margin-top:15px;" onclick="payEntry()">Pay Entry Fee ₹10</button>
  <button id="joinBtn" disabled class="logoutBtn" style="margin-top:15px;background:#555;" onclick="openRegistration()">Join Quiz</button>
</div>

<!-- ✅ REGISTRATION -->
<div id="registerScreen" class="hidden">
  <button class="backBtn" onclick="goBackContest()">⭠ Back</button>
  <div class="sectionHeader">Contest Registration</div>
  <input id="name" placeholder="Full Name">
  <input id="father" placeholder="Father's Name">
  <input id="mobile" placeholder="Mobile Number">
  <div class="notice">Please fill correct details. You’ll be contacted on this number if you win. Quiz duration: 6 minutes.</div>
  <button class="logoutBtn" onclick="submitDetails()">Submit Details</button>
  <button class="logoutBtn" style="margin-top:10px;background:linear-gradient(90deg,#ff5858,#ff9e00);" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- ✅ QUIZ -->
<div id="quizScreen" class="hidden">
  <div class="sectionHeader">Contest Quiz</div>
  <div class="timerBox">⏱ <span id="timer">06:00</span></div>
  <div id="quizBox"></div>
</div>

<!-- ✅ RESULT -->
<div id="resultScreen" class="hidden">
  <div class="sectionHeader">Quiz Completed!</div>
  <h3 id="scoreText"></h3>
  <button onclick="goHome()" class="logoutBtn">Back to Home</button>
</div>

<script>
// ✅ GITHUB JSON LINKS
const links = {
  sections: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/sections.json",
  current: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_currentaffairs.json",
  practice: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upsc%20practise%20questions.json",
  mindmap: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/mindmaps.json",
  interview: "https://raw.githubusercontent.com/avnoordeepsingh733-svg/Avnoor/main/upscinterviewpractisequestions.json",
  books: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/upsc_books.json",
  social: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/social_media_material.json",
  contestNotice: "https://raw.githubusercontent.com/Sajanpreet35/Bighit/main/contest_notice.json",
  quiz: "https://raw.githubusercontent.com/Sajanpreet35/Upsc-quiz-/main/upsc_quiz.json"
};

// ✅ Supabase init
const SUPABASE_URL = "https://zkqegvyxmtwyznizuhjt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprcWVndnl4bXR3eXpuaXp1aGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjkxMDYsImV4cCI6MjA3NjIwNTEwNn0.hC01DVzpgFg_cAVBs-Q6dalvUh1oU5OJ5NxkoEVY36o";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ✅ Load home sections dynamically
async function loadSections(){
  const res = await fetch(links.sections);
  const data = await res.json();
  const grid = document.getElementById("sectionsGrid");
  grid.innerHTML="";
  data.forEach(sec=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<img src="${sec.icon}"><div>${sec.name}</div>`;
    div.onclick=()=>openSection(sec.id);
    grid.appendChild(div);
  });
}

// ✅ Open section or contest
async function openSection(sec){
  document.getElementById("homeScreen").classList.add("hidden");
  if(sec==="contest"){openContest();return;}
  document.getElementById("sectionScreen").classList.remove("hidden");
  const data=await fetch(links[sec]).then(r=>r.json());
  document.getElementById("secTitle").innerText=data.title||sec;
  const list=document.getElementById("imgList");
  list.innerHTML="";
  (data.images||[]).forEach(src=>{
    const img=document.createElement("img");
    img.src=src;list.appendChild(img);
  });
}

// ✅ Contest Screen
async function openContest(){
  document.getElementById("contestScreen").classList.remove("hidden");
  const { data } = await supabase.from("aspirants").select("*");
  const joined=data?data.length:0;
  document.getElementById("joinedCount").innerText=joined;
  document.getElementById("progressBar").style.width=(joined/1000)*100+"%";
  const notice=await fetch(links.contestNotice).then(r=>r.json());
  document.getElementById("contestNotice").innerText=notice.text;
}

function payEntry(){
  alert("✅ Payment Successful (Demo)");
  document.getElementById("joinBtn").disabled=false;
  document.getElementById("joinBtn").style.background="linear-gradient(90deg,#007bff,#00d4ff)";
}

function openRegistration(){
  document.getElementById("contestScreen").classList.add("hidden");
  document.getElementById("registerScreen").classList.remove("hidden");
}

async function submitDetails(){
  const name=document.getElementById("name").value.trim();
  const father=document.getElementById("father").value.trim();
  const mobile=document.getElementById("mobile").value.trim();
  if(!name||!father||!mobile){alert("Please fill all fields.");return;}
  const { error } = await supabase.from("aspirants").insert([{name,father_name:father,mobile}]);
  alert(error?"❌ Error saving details":"✅ Details Saved!");
}

// ✅ Quiz Logic
let quizData=[],current=0,score=0,seconds=360,timerInt;
async function startQuiz(){
  document.getElementById("registerScreen").classList.add("hidden");
  document.getElementById("quizScreen").classList.remove("hidden");
  quizData=await fetch(links.quiz).then(r=>r.json());
  current=0;score=0;seconds=360;
  startTimer();showQuestion();
}

function startTimer(){
  updateTimer();
  timerInt=setInterval(()=>{
    seconds--;updateTimer();
    if(seconds<=0){clearInterval(timerInt);finishQuiz();}
  },1000);
}
function updateTimer(){
  let m=Math.floor(seconds/60),s=seconds%60;
  document.getElementById("timer").innerText=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
function showQuestion(){
  const q=quizData[current];
  if(!q)return finishQuiz();
  const box=document.getElementById("quizBox");
  box.innerHTML=`<h3>Q${current+1}. ${q.question}</h3>`;
  for(const key in q.options){
    const div=document.createElement("div");
    div.className="option";
    div.innerText=`${key}. ${q.options[key]}`;
    div.onclick=()=>{if(key===q.correct_answer)score++;nextQuestion();};
    box.appendChild(div);
  }
}
function nextQuestion(){current++;showQuestion();}
async function finishQuiz(){
  clearInterval(timerInt);
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("resultScreen").classList.remove("hidden");
  document.getElementById("scoreText").innerText=`You scored ${score}/${quizData.length}`;
  await supabase.from("contest_result").insert([{score}]);
}

// ✅ Navigation
function goBackContest(){
  document.getElementById("registerScreen").classList.add("hidden");
  document.getElementById("contestScreen").classList.remove("hidden");
}
function goHome(){
  document.querySelectorAll("div").forEach(d=>d.classList.add("hidden"));
  document.getElementById("homeScreen").classList.remove("hidden");
}
function logoutUser(){location.reload();}

// ✅ Load initial
loadSections();
</script>
</body>
</html>
