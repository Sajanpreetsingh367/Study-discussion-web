<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Study Discussion Club</title>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDwbIHTMWM_AQ-NlsdXGDzAfoC8Tf8lZiY",
  authDomain:"study-discussion-club.firebaseapp.com",
  projectId:"study-discussion-club",
  storageBucket:"study-discussion-club.appspot.com",
  messagingSenderId:"383378613377",
  appId:"1:383378613377:web:3b932c6b42076352811980"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.F = { db, doc, getDoc, setDoc, auth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut };
</script>

<style>
html,body,#root{height:100%;margin:0;padding:0;font-family:"Poppins",sans-serif;background:black;overflow:auto;color:white;}
.centerBox{display:flex;flex-direction:column;align-items:center;text-align:center;padding:20px;}
input{padding:10px;margin:6px;width:90%;max-width:300px;border-radius:8px;border:none;}
.btn{width:100%;padding:12px;margin-top:12px;border:none;border-radius:10px;font-weight:700;font-size:15px;color:#fff;background:linear-gradient(90deg,#6C63FF,#00C2A8);}
.backBtn{cursor:pointer;color:#00C2A8;position:absolute;top:20px;left:20px;}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const {useState,useEffect}=React;
const F=window.F;

function HomeApp(){
  const [screen,setScreen]=useState("loading");
  const [user,setUser]=useState(null);
  const [subscribed,setSubscribed]=useState(false);

  useEffect(()=>{
    F.onAuthStateChanged(F.auth,async(u)=>{
      if(!u){ setScreen("auth"); return; }
      setUser(u);

      const docRef = F.doc(F.db,"users",u.uid);
      const snap = await F.getDoc(docRef);

      if(snap.exists()){
        const data = snap.data();
        if(!data.pin){
          setScreen("auth"); // No PIN set
        } else {
          setScreen("pinVerify");
        }
        setSubscribed(data.subscribed || false);
      }
    });
  },[]);

  if(screen==="loading") return <div className="centerBox">Loading...</div>;
  if(screen==="auth") return <AuthScreen setScreen={setScreen}/>;
  if(screen==="pinVerify") return <PinVerifyScreen user={user} subscribed={subscribed} setScreen={setScreen}/>;
  if(screen==="subscription") return <SubscriptionScreen user={user} setSubscribed={setSubscribed} setScreen={setScreen}/>;
  if(screen==="home") return <HomeScreen/>;

  return <div className="centerBox">Loading...</div>;
}

function AuthScreen({setScreen}){
  const [email,setEmail]=useState("");
  const [password,setPassword]=useState("");
  const [pin,setPin]=useState("");

  const signup = async ()=>{
    if(pin.length!==6) return alert("Enter 6 digit PIN");
    try{
      const res = await F.createUserWithEmailAndPassword(F.auth,email,password);
      await F.setDoc(F.doc(F.db,"users",res.user.uid),{
        subscribed:false,
        pin:pin
      });
      setScreen("subscription");
    }catch(e){alert(e.message);}
  };

  const login = async ()=>{
    try{
      await F.signInWithEmailAndPassword(F.auth,email,password);
      setScreen("pinVerify");
    }catch(e){alert(e.message);}
  };

  return (
    <div className="centerBox">
      <h2>Login / Signup</h2>
      <input value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="Email"/>
      <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} placeholder="Password"/>
      <input type="password" value={pin} onChange={(e)=>setPin(e.target.value)} maxLength="6" placeholder="6 Digit PIN"/>
      <button className="btn" onClick={login}>Login</button>
      <button className="btn" onClick={signup}>Signup</button>
    </div>
  );
}

function PinVerifyScreen({user,subscribed,setScreen}){
  const [pin,setPin]=useState("");

  const verify = async ()=>{
    const snap = await F.getDoc(F.doc(F.db,"users",user.uid));
    if(snap.exists() && snap.data().pin===pin){
      setScreen(subscribed?"home":"subscription");
    } else alert("Wrong PIN");
  };

  const logout = async ()=>{ await F.signOut(F.auth); setScreen("auth"); };

  return (
    <div className="centerBox">
      <h2>Enter PIN</h2>
      <input type="password" maxLength="6" value={pin} onChange={(e)=>setPin(e.target.value)} placeholder="6 Digit PIN"/>
      <button className="btn" onClick={verify}>Unlock App</button>
      <button style={{marginTop:10,color:"red"}} onClick={logout}>Logout</button>
    </div>
  );
}

function SubscriptionScreen({user,setSubscribed,setScreen}){
  const buy=async()=>{
    await F.setDoc(F.doc(F.db,"users",user.uid),{subscribed:true},{merge:true});
    setSubscribed(true);
    setScreen("home");
  };
  return (
    <div className="centerBox">
      <h2>Buy Subscription â‚¹99</h2>
      <button className="btn" onClick={buy}>Pay â‚¹99</button>
    </div>
  );
}

function HomeScreen(){
  return (
    <div className="centerBox">
      <h2>ðŸŽ‰ Welcome Home!</h2>
      <p>Subscription Active âœ…</p>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<HomeApp/>);

</script>
</body>
</html>
